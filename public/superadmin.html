<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - Sistema SEF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
        }

        .message {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .message.success {
            background-color: #d1fae5;
            color: #065f46;
        }

        .message.error {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .message.info {
            background-color: #e0f2fe;
            color: #0c4a6e;
        }

        /* Estilos para as abas */
        .tab-btn {
            padding: 0.75rem 1.5rem;
            margin-bottom: -1px;
            border-bottom-width: 2px;
            font-weight: 600;
            cursor: pointer;
        }

        .tab-btn-active {
            border-color: #4f46e5;
            /* indigo-600 */
            color: #4f46e5;
        }

        .tab-btn-inactive {
            border-color: transparent;
            color: #6b7280;
            /* gray-500 */
        }

        .tab-btn-inactive:hover {
            border-color: #d1d5db;
            /* gray-300 */
            color: #374151;
            /* gray-700 */
        }
    </style>
</head>

<body>
    <nav class="bg-gray-800 p-4 shadow-md">
        <div class="mx-auto flex max-w-7xl items-center justify-between px-4">
            <a href="superadmin.html" class="text-white text-2xl font-bold text-left">EDU SEF - PAINEL SUPER ADMIN</a>
            <div class="flex items-center space-x-4">
                <button onclick="logout()"
                    class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200">Sair</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto max-w-7xl py-12 px-4">

        <div class="mb-6 border-b border-gray-200">
            <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                <button id="tab-btn-escolas" class="tab-btn tab-btn-active">
                    Gerenciar Escolas
                </button>
                <button id="tab-btn-consultas" class="tab-btn tab-btn-inactive">
                    Consultas Globais
                </button>
            </nav>
        </div>

        <div id="tab-panel-escolas">
            <section id="gerenciar-escolas-section">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-2xl font-semibold text-gray-700">Gerenciar Escolas</h2>
                    <button id="btn-nova-escola"
                        class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">
                        + Nova Escola
                    </button>
                </div>

                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ID</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Nome da Escola</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Admin</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Alunos</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Professores</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Pendências</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Ações</th>
                            </tr>
                        </thead>
                        <tbody id="escolas-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <div id="tab-panel-consultas" class="hidden">
            <section id="consulta-sef-section" class="mb-12">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Consulta SEF Global</h2>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="form-group mb-4 max-w-md">
                        <label for="cpf-consulta">CPF do Responsável</label>
                        <input type="text" id="cpf-consulta" placeholder="Digite apenas números" maxlength="14"
                            class="form-group input">
                    </div>
                    <button id="btn-consultar-cpf"
                        class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700">
                        Consultar Pendências
                    </button>
                    <div id="consulta-cpf-result" class="mt-6"></div>
                </div>
            </section>

            <section id="consulta-ra-section" class="mb-12">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Consulta Aluno Global por RA</h2>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="form-group mb-4 max-w-md">
                        <label for="ra-consulta">RA do Aluno</label>
                        <input type="text" id="ra-consulta" placeholder="Digite o RA do aluno" class="form-group input">
                    </div>
                    <button id="btn-consultar-ra"
                        class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">
                        Consultar Aluno
                    </button>
                    <div id="consulta-ra-result" class="mt-6"></div>
                </div>
            </section>
        </div>

    </main>

    <div id="modal-escola" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-escola-title" class="text-2xl font-bold text-gray-800">Nova Escola</h2>
                <button id="close-modal-escola" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div id="escola-stats-area-edit" class="mb-6 p-4 bg-gray-50 rounded-lg hidden">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Estatísticas</h3>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <div class="text-center p-3 bg-white rounded shadow-sm">
                        <span class="block text-2xl font-bold text-indigo-600" id="stat-alunos-edit">0</span>
                        <span class="text-sm text-gray-500">Alunos</span>
                    </div>
                    <div class="text-center p-3 bg-white rounded shadow-sm">
                        <span class="block text-2xl font-bold text-indigo-600" id="stat-professores-edit">0</span>
                        <span class="text-sm text-gray-500">Professores</span>
                    </div>
                    <div class="text-center p-3 bg-white rounded shadow-sm">
                        <span class="block text-2xl font-bold text-indigo-600" id="stat-responsaveis-edit">0</span>
                        <span class="text-sm text-gray-500">Responsáveis</span>
                    </div>
                    <div class="text-center p-3 bg-white rounded shadow-sm">
                        <span class="block text-2xl font-bold text-red-600" id="stat-pendencias-edit">0</span>
                        <span class="text-sm text-gray-500">Com Pendências</span>
                    </div>
                </div>
            </div>

            <div id="modal-message-area" class="message hidden"></div>

            <form id="form-escola" novalidate>
                <input type="hidden" id="escola-id" name="escola-id">

                <div class="space-y-4">
                    <div class="form-group">
                        <label for="escola-nome">Nome da Escola <span class="text-red-500">*</span></label>
                        <input type="text" id="escola-nome" name="escola-nome" required>
                    </div>
                    <div class="form-group">
                        <label for="escola-endereco">Endereço</label>
                        <input type="text" id="escola-endereco" name="escola-endereco">
                    </div>
                    <div class="form-group">
                        <label for="escola-telefone">Telefone</label>
                        <input type="text" id="escola-telefone" name="escola-telefone" maxlength="15">
                    </div>

                    <div id="admin-credentials-fields" class="space-y-4 pt-4 border-t">
                        <h3 class="text-lg font-semibold text-gray-700">Credenciais do Admin da Escola</h3>
                        <div class="form-group">
                            <label for="escola-admin-username">Username <span class="text-red-500">*</span></label>
                            <input type="text" id="escola-admin-username" name="escola-admin-username" required>
                        </div>
                        <div class="form-group">
                            <label for="escola-admin-password">Senha <span class="text-red-500">*</span></label>
                            <input type="password" id="escola-admin-password" name="escola-admin-password" required>
                        </div>
                    </div>
                </div>

                <div class="mt-8 pt-6 border-t flex justify-end">
                    <button id="btn-salvar-escola"
                        class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-stats-view"
        class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-stats-title" class="text-2xl font-bold text-gray-800">Estatísticas</h2>
                <button id="close-modal-stats" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <div class="text-center p-3 bg-white rounded shadow-sm">
                        <span class="block text-3xl font-bold text-indigo-600" id="stat-alunos-view">0</span>
                        <span class="text-sm text-gray-500">Alunos</span>
                    </div>
                    <div class="text-center p-3 bg-white rounded shadow-sm">
                        <span class="block text-3xl font-bold text-indigo-600" id="stat-professores-view">0</span>
                        <span class="text-sm text-gray-500">Professores</span>
                    </div>
                    <div class="text-center p-3 bg-white rounded shadow-sm">
                        <span class="block text-3xl font-bold text-indigo-600" id="stat-responsaveis-view">0</span>
                        <span class="text-sm text-gray-500">Responsáveis</span>
                    </div>
                    <div class="text-center p-3 bg-white rounded shadow-sm">
                        <span class="block text-3xl font-bold text-red-600" id="stat-pendencias-view">0</span>
                        <span class="text-sm text-gray-500">Com Pendências</span>
                    </div>
                </div>
            </div>

            <div class="mt-8 pt-6 border-t flex justify-end">
                <button id="btn-close-modal-stats"
                    class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600">Fechar</button>
            </div>
        </div>
    </div>


    <script>
        const API_BASE_URL = '/api';

        // ***** Elementos das Abas *****
        const tabBtnEscolas = document.getElementById('tab-btn-escolas');
        const tabBtnConsultas = document.getElementById('tab-btn-consultas');
        const tabPanelEscolas = document.getElementById('tab-panel-escolas');
        const tabPanelConsultas = document.getElementById('tab-panel-consultas');


        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        // ***** FUNÇÃO PARA TROCAR DE ABA *****
        function switchTab(targetTab) {
            if (targetTab === 'escolas') {
                // Ativa o painel de escolas
                tabPanelEscolas.classList.remove('hidden');
                tabPanelConsultas.classList.add('hidden');
                // Ativa o botão da aba de escolas
                tabBtnEscolas.classList.add('tab-btn-active');
                tabBtnEscolas.classList.remove('tab-btn-inactive');
                tabBtnConsultas.classList.add('tab-btn-inactive');
                tabBtnConsultas.classList.remove('tab-btn-active');
            } else if (targetTab === 'consultas') {
                // Ativa o painel de consultas
                tabPanelConsultas.classList.remove('hidden');
                tabPanelEscolas.classList.add('hidden');
                // Ativa o botão da aba de consultas
                tabBtnConsultas.classList.add('tab-btn-active');
                tabBtnConsultas.classList.remove('tab-btn-inactive');
                tabBtnEscolas.classList.add('tab-btn-inactive');
                tabBtnEscolas.classList.remove('tab-btn-active');
            }
        }

        // --- AUTENTICAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('jwt_token');
            const role = localStorage.getItem('user_role');

            if (!token || role !== 'super_admin') {
                alert('Acesso negado.');
                logout();
                return;
            }

            loadEscolas(); // Carrega a tabela de escolas (na aba padrão)

            // --- Event Listeners ---

            // (Listeners das Abas)
            tabBtnEscolas.addEventListener('click', () => switchTab('escolas'));
            tabBtnConsultas.addEventListener('click', () => switchTab('consultas'));

            // (Listeners das Consultas)
            document.getElementById('btn-consultar-cpf').addEventListener('click', handleConsultaCpf);
            document.getElementById('btn-consultar-ra').addEventListener('click', handleConsultaRa);

            // (Listeners dos Modais)
            document.getElementById('btn-nova-escola').addEventListener('click', () => {
                openEscolaModal(null);
            });
            document.getElementById('close-modal-escola').addEventListener('click', closeEscolaModal);
            document.getElementById('form-escola').addEventListener('submit', handleSaveEscola);
            document.getElementById('close-modal-stats').addEventListener('click', closeStatsModal);
            document.getElementById('btn-close-modal-stats').addEventListener('click', closeStatsModal);
        });

        // --- LÓGICA DE CONSULTA CPF ---
        async function handleConsultaCpf() {
            const cpf = document.getElementById('cpf-consulta').value.replace(/\D/g, '');
            const resultDiv = document.getElementById('consulta-cpf-result');
            const token = localStorage.getItem('jwt_token');

            if (cpf.length !== 11) {
                resultDiv.innerHTML = `<div class="message error">Por favor, digite um CPF válido.</div>`;
                return;
            }
            resultDiv.innerHTML = `<div class="message info">Consultando...</div>`;
            try {
                const response = await fetch(`${API_BASE_URL}/superadmin/consulta-sef`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ cpf: cpf })
                });
                const result = await response.json();
                if (response.ok) {
                    let html = `<div class="message error"><strong>Atenção: ${result.total_pendencias} pendência(s) encontrada(s).</strong><ul class="list-disc list-inside mt-2">`;

                    // ***** ATUALIZADO (Consulta CPF) *****
                    result.data.forEach(p => {
                        html += `<li>Nome: ${p.nome_responsavel} | Valor: R$ ${p.valor} | Credor: ${p.credor} | <strong>Escola: ${p.nome_escola}</strong></li>`;
                    });

                    html += `</ul></div>`;
                    resultDiv.innerHTML = html;
                } else {
                    if (response.status === 404) {
                        resultDiv.innerHTML = `<div class="message success"><strong>CPF Válido:</strong> Nenhuma pendência encontrada para este CPF.</div>`;
                    } else {
                        resultDiv.innerHTML = `<div class="message error">${result.message}</div>`;
                    }
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="message error">Erro de conexão: ${error.message}</div>`;
            }
        }

        // --- LÓGICA DE CONSULTA ALUNO POR RA ---
        async function handleConsultaRa() {
            const ra = document.getElementById('ra-consulta').value.trim();
            const resultDiv = document.getElementById('consulta-ra-result');
            const token = localStorage.getItem('jwt_token');

            if (ra === '') {
                resultDiv.innerHTML = `<div class="message error">Por favor, digite um RA.</div>`;
                return;
            }
            resultDiv.innerHTML = `<div class="message info">Consultando...</div>`;
            try {
                const response = await fetch(`${API_BASE_URL}/superadmin/consulta-aluno`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ ra: ra })
                });
                const result = await response.json();
                if (response.ok) {
                    let html = `<div class="message success"><strong>${result.total_encontrados} aluno(s) encontrado(s):</strong><ul class="list-disc list-inside mt-2">`;

                    // ***** ATUALIZADO (Consulta RA) *****
                    result.data.forEach(aluno => {
                        html += `<li>RA: ${aluno.ra_sef} | Aluno: ${aluno.nome_aluno} | Responsável: ${aluno.nome_responsavel_financeiro || 'N/D'} | Turma: ${aluno.nome_turma || 'N/D'} | <strong>Escola: ${aluno.nome_escola}</strong></li>`;
                    });

                    html += `</ul></div>`;
                    resultDiv.innerHTML = html;
                } else {
                    if (response.status === 404) {
                        resultDiv.innerHTML = `<div class="message error"><strong>RA não encontrado:</strong> Nenhum aluno localizado com este RA.</div>`;
                    } else {
                        resultDiv.innerHTML = `<div class="message error">${result.message}</div>`;
                    }
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="message error">Erro de conexão: ${error.message}</div>`;
            }
        }


        // --- LÓGICA CRUD ESCOLAS (Modal de Edição) ---
        const modal = document.getElementById('modal-escola');
        const modalMsg = document.getElementById('modal-message-area');
        const form = document.getElementById('form-escola');
        const adminFields = document.getElementById('admin-credentials-fields');
        const statsAreaEdit = document.getElementById('escola-stats-area-edit');

        function openEscolaModal(escola = null) {
            form.reset();
            modalMsg.classList.add('hidden');
            document.getElementById('escola-id').value = '';
            if (escola) {
                document.getElementById('modal-escola-title').textContent = 'Editar Escola';
                document.getElementById('escola-id').value = escola.id_escola;
                document.getElementById('escola-nome').value = escola.nome_escola;
                document.getElementById('escola-endereco').value = escola.endereco;
                document.getElementById('escola-telefone').value = escola.telefone;
                adminFields.classList.add('hidden');
                statsAreaEdit.classList.remove('hidden');
                document.getElementById('stat-alunos-edit').textContent = escola.total_alunos || 0;
                document.getElementById('stat-professores-edit').textContent = escola.total_professores || 0;
                document.getElementById('stat-responsaveis-edit').textContent = escola.total_responsaveis_financeiros || 0;
                document.getElementById('stat-pendencias-edit').textContent = escola.total_responsaveis_com_pendencias || 0;
            } else {
                document.getElementById('modal-escola-title').textContent = 'Nova Escola';
                adminFields.classList.remove('hidden');
                statsAreaEdit.classList.add('hidden');
            }
            modal.classList.remove('hidden');
        }

        function closeEscolaModal() {
            modal.classList.add('hidden');
        }

        // --- LÓGICA MODAL DE ESTATÍSTICAS ---
        const modalStats = document.getElementById('modal-stats-view');

        function openStatsModal(escola) {
            document.getElementById('modal-stats-title').textContent = `Estatísticas: ${escola.nome_escola}`;
            document.getElementById('stat-alunos-view').textContent = escola.total_alunos || 0;
            document.getElementById('stat-professores-view').textContent = escola.total_professores || 0;
            document.getElementById('stat-responsaveis-view').textContent = escola.total_responsaveis_financeiros || 0;
            document.getElementById('stat-pendencias-view').textContent = escola.total_responsaveis_com_pendencias || 0;
            modalStats.classList.remove('hidden');
        }

        function closeStatsModal() {
            modalStats.classList.add('hidden');
        }

        function showModalMessage(message, type) {
            modalMsg.textContent = message;
            modalMsg.className = `message ${type}`;
            modalMsg.classList.remove('hidden');
        }

        async function loadEscolas() {
            const token = localStorage.getItem('jwt_token');
            const tableBody = document.getElementById('escolas-table-body');
            tableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Carregando...</td></tr>';
            try {
                const response = await fetch(`${API_BASE_URL}/superadmin/escolas`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                if (result.success) {
                    tableBody.innerHTML = '';
                    if (result.data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Nenhuma escola cadastrada.</td></tr>';
                        return;
                    }
                    result.data.forEach(escola => {
                        const tr = document.createElement('tr');
                        const escolaJson = JSON.stringify(escola).replace(/"/g, "&quot;");
                        const pendenciasTxt = `${escola.total_responsaveis_com_pendencias || 0} / ${escola.total_responsaveis_financeiros || 0}`;
                        const pendenciasClass = (escola.total_responsaveis_com_pendencias > 0) ? 'text-red-600 font-bold' : 'text-gray-500';
                        tr.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${escola.id_escola}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                                <button onclick='openStatsModal(${escolaJson})' class="font-medium text-indigo-600 hover:text-indigo-900 hover:underline">
                                    ${escola.nome_escola}
                                </button>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${escola.admin_username || '---'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${escola.total_alunos || 0}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${escola.total_professores || 0}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${pendenciasClass}">${pendenciasTxt}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                <button onclick='handleEdit(${escolaJson})' class="text-indigo-600 hover:text-indigo-900">Editar</button>
                                <button onclick="handleDelete(${escola.id_escola})" class="text-red-600 hover:text-red-900">Excluir</button>
                            </td>
                        `;
                        tableBody.appendChild(tr);
                    });
                } else {
                    tableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-center text-red-500">Erro: ${result.message}</td></tr>`;
                }
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-center text-red-500">Erro de conexão: ${error.message}</td></tr>`;
            }
        }

        function handleEdit(escola) {
            openEscolaModal(escola);
        }

        async function handleDelete(id) {
            if (!confirm(`Tem certeza que deseja excluir a escola ID ${id}? \n\Atenção: Isso só funcionará se a escola não tiver NENHUM aluno, turma ou professor vinculado. É recomendável apenas para escolas vazias.`)) {
                return;
            }
            const token = localStorage.getItem('jwt_token');
            try {
                const response = await fetch(`${API_BASE_URL}/superadmin/escolas/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                if (result.success) {
                    alert('Escola excluída com sucesso!');
                    loadEscolas();
                } else {
                    alert(`Erro: ${result.message}`);
                }
            } catch (error) {
                alert(`Erro de conexão: ${error.message}`);
            }
        }

        async function handleSaveEscola(event) {
            event.preventDefault();
            const token = localStorage.getItem('jwt_token');
            const id = document.getElementById('escola-id').value;
            const isEditing = !!id;

            const data = {
                nome_escola: document.getElementById('escola-nome').value,
                endereco: document.getElementById('escola-endereco').value,
                telefone: document.getElementById('escola-telefone').value
            };

            let url = `${API_BASE_URL}/superadmin/escolas`;
            let method = 'POST';

            if (isEditing) {
                url = `${API_BASE_URL}/superadmin/escolas/${id}`;
                method = 'PUT';
            } else {
                data.admin_username = document.getElementById('escola-admin-username').value;
                data.admin_password = document.getElementById('escola-admin-password').value;
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    showModalMessage(result.message, 'success');
                    loadEscolas();
                    setTimeout(closeEscolaModal, 1500);
                } else {
                    showModalMessage(result.message, 'error');
                }

            } catch (error) {
                showModalMessage(`Erro de conexão: ${error.message}`, 'error');
            }
        }
    </script>
</body>

</html>