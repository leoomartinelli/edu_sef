<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Alunos - Sistema Crescer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="./img/EDU SEF.png">
    <link rel="stylesheet" href="css/loader.css">
    <script src="js/loader.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 1rem;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        .btn-primary {
            background-color: #4f46e5;
            color: #ffffff;
        }

        .btn-primary:hover {
            background-color: #4338ca;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: #ffffff;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .btn-edit {
            background-color: #22c55e;
            color: #ffffff;
        }

        .btn-edit:hover {
            background-color: #16a34a;
        }

        .btn-delete {
            background-color: #ef4444;
            color: #ffffff;
        }

        .btn-delete:hover {
            background-color: #dc2626;
        }

        .btn-info {
            background-color: #3b82f6;
            color: #ffffff;
        }

        .btn-info:hover {
            background-color: #2563eb;
        }

        .message {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .message.success {
            background-color: #d1fae5;
            color: #065f46;
        }

        .message.error {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .modal {
            display: none;
            /* AQUI ESTAVA O ERRO - A SEGUNDA LINHA "display: flex" FOI REMOVIDA */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 800px;
            position: relative;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .search-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: flex-end;
        }

        .search-group input {
            flex-grow: 1;
        }

        .search-group button {
            flex-shrink: 0;
        }

        .btn-small {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        /* Estilo padrão para os links da navbar */
        .nav-link {
            color: #D1D5DB;
            /* cinza claro */
            background-color: transparent;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }

        .nav-link:hover {
            background-color: #374151;
            /* cinza mais escuro */
            color: #FFFFFF;
        }

        /* Estilo para o link da PÁGINA ATUAL */
        .nav-link.active {
            background-color: #111827;
            /* cinza bem escuro */
            color: #FFFFFF;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <nav class="bg-gray-800 p-4 shadow-md">
        <div class="mx-auto flex max-w-7xl items-center justify-between px-4">

            <a href="home.html" class="text-white text-2xl font-bold text-left">EDU SEF - Sistema Educacional
                Financeiro</a>

            <div class="flex items-center space-x-4">
                <div class="relative group">
                    <button class="nav-link">
                        Consultas <span class="ml-1">&#9660;</span>
                    </button>
                    <div
                        class="absolute right-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg py-1 z-10 hidden group-hover:block">
                        <a href="crud_consultar_cpf.html"
                            class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700">Consulta SEF</a>
                        <a href="crud_consulta_detalhada_cpf.html"
                            class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700">Consulta Detalhada</a>
                    </div>
                </div>
                <a href="crud_alunos.html" class="nav-link active">Alunos</a>
                <a href="crud_turmas.html" class="nav-link">Turmas</a>
                <a href="crud_professores.html" class="nav-link">Professores</a>
                <a href="crud_disciplinas.html" class="nav-link">Disciplinas</a>
                <a href="conteudo_programatico.html" class="nav-link">Conteúdo Programático</a>
                <a href="crud_mensalidades.html" class="nav-link">Mensalidades</a>
                <a href="gerenciar_contratos.html" class="nav-link">Contratos</a>
                <a href="financeiro.html" class="nav-link">Financeiro</a>



                <a id="nav-gerenciar-usuarios" href="gerenciar_usuarios.html" class="nav-link">Gerenciar Usuários</a>
                <button onclick="logout()" class="nav-link">Sair</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="mb-8 p-6 bg-gray-50 border border-gray-200 rounded-lg">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Importar Alunos em Massa</h2>
            <p class="mb-4 text-gray-600">
                Faça o upload de uma planilha (.xlsx) para cadastrar múltiplos alunos, responsáveis e turmas de uma só
                vez.
                <a href="/templates/Template.xlsx" download class="text-blue-600 hover:underline font-semibold">Baixe o
                    modelo aqui.</a>
            </p>
            <div class="flex items-center space-x-4">
                <input type="file" id="arquivoAlunos" accept=".xlsx, .xls"
                    class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <button id="btnImportar"
                    class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                    Importar
                </button>
            </div>
            <div id="importStatus" class="mt-4 text-sm"></div>
        </div>
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">
            Gerenciamento de Alunos
            <span id="total-alunos-display"
                class="text-lg font-normal bg-blue-100 text-blue-800 px-3 py-1 rounded-full align-middle ml-2"></span>
        </h1>
        <div id="message-area" class="message hidden"></div>




        <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-semibold text-gray-700">Buscar Alunos</h2>
                <button id="toggle-filter-btn" class="btn btn-secondary flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z"
                            clip-rule="evenodd" />
                    </svg>
                    Filtrar
                </button>
            </div>

            <div id="filter-area" class="hidden mt-4 transition-all duration-300">
                <div class="search-group">
                    <div class="form-group mb-0">
                        <label for="search_name">Buscar por Nome</label>
                        <input type="text" id="search_name" name="search_name" placeholder="Digite o nome do aluno">
                    </div>
                    <div class="form-group mb-0">
                        <label for="search_ra_sef">Buscar por RA SEF</label>
                        <input type="text" id="search_ra_sef" name="search_ra" placeholder="Digite o RA SEF do aluno">
                    </div>
                    <button class="btn btn-primary btn-small" onclick="fetchAlunos()">Buscar</button>
                    <button class="btn btn-secondary btn-small" onclick="clearSearch()">Limpar Busca</button>
                </div>
            </div>
        </div>


        <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Alunos Cadastrados</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left">ID</th>
                            <th class="px-4 py-2 text-left">Nome</th>
                            <th class="px-4 py-2 text-left">RA SEF</th>
                            <th class="px-4 py-2 text-left">Turma</th>
                            <th class="px-4 py-2 text-left">Responsável</th>
                            <th class="px-4 py-2 text-left">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="alunos-table-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="alunoModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2 id="modal-title" class="text-2xl font-semibold text-gray-700 mb-4"></h2>
            <div id="modal-message-area" class="message hidden"></div>
            <form id="aluno-form" class="max-h-[70vh] overflow-y-auto p-2">
                <input type="hidden" id="id_aluno">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-3">
                        <h3 class="text-lg font-semibold border-b pb-1">Dados do Aluno (a)</h3>
                    </div>
                    <div class="form-group"><label for="nome_aluno">Nome Completo <span
                                class="text-red-500">*</span></label><input type="text" id="nome_aluno"
                            name="nome_aluno" required></div>
                    <div class="form-group"><label for="ra_sef">RA SEF (Gerado automaticamente)</label><input
                            type="text" id="ra_sef" name="ra_sef" readonly class="bg-gray-200"></div>
                    <div class="form-group"><label for="ra">RA (Opcional)</label><input type="text" id="ra" name="ra">
                    </div>
                    <div class="form-group"><label for="data_nascimento">Data de Nascimento</label><input type="date"
                            id="data_nascimento" name="data_nascimento"></div>
                    <div class="form-group"><label for="cpf_aluno">CIN/CPF do Aluno (a)</label><input type="text" id="cpf_aluno"
                            name="cpf_aluno"></div>
                    <div class="form-group"><label for="idade">Idade</label><input type="number" id="idade" name="idade"
                            readonly class="bg-gray-200"></div>

                    <div class="form-group">
                        <label for="id_turma">Turma</label>
                        <div class="flex items-center gap-2">
                            <select id="id_turma" name="id_turma" class="flex-grow">
                                <option value="">Selecione</option>
                            </select>
                            <button type="button" onclick="openAddTurmaModal()"
                                class="btn btn-info btn-small flex-shrink-0">Nova</button>
                        </div>
                    </div>
                    <div class="form-group"><label for="periodo">Período</label><select id="periodo" name="periodo">
                            <option value="">Selecione</option>
                            <option>Manhã</option>
                            <option>Tarde</option>
                            <option>Noite</option>
                        </select></div>

                    <div class="form-group">
                        <label for="ano_inicio">Ano de Início (Ano Letivo) <span class="text-red-500">*</span></label>
                        <input type="number" id="ano_inicio" name="ano_inicio" placeholder="Ex: 2025" min="2020"
                            max="2050" required>
                    </div>

                    <div class="form-group">
                        <label for="data_inicio">Data de Início das Aulas (Opcional)</label>
                        <input type="date" id="data_inicio" name="data_inicio">
                    </div>

                    <div class="md:col-span-3 mt-4">
                        <h3 class="text-lg font-semibold border-b pb-1">Endereço</h3>
                    </div>
                    <div class="form-group"><label for="cep">CEP</label><input type="text" id="cep" name="cep"
                            maxlength="9"></div>
                    <div class="form-group md:col-span-2"><label for="endereco">Endereço</label><input type="text"
                            id="endereco" name="endereco"></div>
                    <div class="form-group"><label for="complemento">Complemento</label><input type="text"
                            id="complemento" name="complemento"></div>
                    <div class="form-group"><label for="bairro">Bairro</label><input type="text" id="bairro"
                            name="bairro"></div>
                    <div class="form-group"><label for="cidade">Cidade</label><input type="text" id="cidade"
                            name="cidade"></div>
                    <div class="form-group"><label for="estado">Estado (UF)</label><input type="text" id="estado"
                            name="estado" maxlength="2"></div>


                    <div class="md:col-span-3 mt-4">
                        <h3 class="text-lg font-semibold border-b pb-1">Responsável Financeiro <span
                                class="text-red-500">*</span></h3>
                        <p class="text-sm text-gray-600">Nome e CPF são obrigatórios.</p>
                    </div>
                    <div class="form-group">
                        <label for="nome_resp_financeiro">Nome</label>
                        <input type="text" id="nome_resp_financeiro" name="nome_resp_financeiro" required>
                    </div>
                    <div class="form-group">
                        <label for="data_nascimento_resp_financeiro">Data de Nascimento</label>
                        <input type="date" id="data_nascimento_resp_financeiro" name="data_nascimento_resp_financeiro">
                    </div>
                    <div class="form-group">
                        <label for="celular_resp_financeiro">Celular</label>
                        <input type="text" id="celular_resp_financeiro" name="celular_resp_financeiro">
                    </div>
                    <div class="form-group">
                        <label for="telefone_resp_financeiro">Telefone</label>
                        <input type="text" id="telefone_resp_financeiro" name="telefone_resp_financeiro">
                    </div>
                    <div class="form-group md:col-span-2">
                        <label for="email_resp_financeiro">Email</label>
                        <input type="email" id="email_resp_financeiro" name="email_resp_financeiro">
                    </div>

                    <div class="md:col-span-3 mt-4">
                        <h3 class="text-lg font-semibold border-b pb-1">Responsável Pedagógico</h3>
                        <p class="text-sm text-gray-600">Preencha se for diferente do financeiro.</p>
                    </div>
                    <div class="form-group">
                        <label for="nome_resp_pedagogico">Nome</label>
                        <input type="text" id="nome_resp_pedagogico" name="nome_resp_pedagogico">
                    </div>
                    <div class="form-group">
                        <label for="data_nascimento_resp_pedagogico">Data de Nascimento</label>
                        <input type="date" id="data_nascimento_resp_pedagogico" name="data_nascimento_resp_pedagogico">
                    </div>
                    <div class="form-group">
                        <label for="celular_resp_pedagogico">Celular</label>
                        <input type="text" id="celular_resp_pedagogico" name="celular_resp_pedagogico">
                    </div>
                    <div class="form-group">
                        <label for="telefone_resp_pedagogico">Telefone</label>
                        <input type="text" id="telefone_resp_pedagogico" name="telefone_resp_pedagogico">
                    </div>
                    <div class="form-group md:col-span-2">
                        <label for="email_resp_pedagogico">Email</label>
                        <input type="email" id="email_resp_pedagogico" name="email_resp_pedagogico">
                    </div>





                    <div class="md:col-span-3 mt-4">
                        <h3 class="text-lg font-semibold border-b pb-1">Financeiro (Geração de Mensalidades)</h3>
                    </div>
                    <div class="form-group">
                        <label for="valor_anuidade_total">Valor da Anuidade (Total do Ano)</label>
                        <input type="number" step="0.01" id="valor_anuidade_total" name="valor_anuidade_total"
                            placeholder="Custo total do ano letivo. Ex: 12400.00" required>
                    </div>
                    <div class="form-group">
                        <label for="valor_matricula">Valor da Matrícula (1ª Cobrança)</label>
                        <input type="number" step="0.01" id="valor_matricula" name="valor_matricula"
                            placeholder="Valor pago no ato. Ex: 1000.00" required>
                    </div>
                    <div class="form-group">
                        <label for="dia_vencimento_mensalidades">Dia de Vencimento das Parcelas</label>
                        <input type="number" id="dia_vencimento_mensalidades" name="dia_vencimento_mensalidades"
                            placeholder="Ex: 10" min="1" max="31" required>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="turmaModal" class="modal" style="z-index: 1050;">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-button" onclick="closeAddTurmaModal()">&times;</span>
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Cadastrar Nova Turma</h2>
            <div id="turma-modal-message-area" class="message hidden"></div>
            <form id="turma-form">
                <div class="space-y-4">
                    <div class="form-group">
                        <label for="turma_nome_turma">Nome da Turma <span class="text-red-500">*</span></label>
                        <input type="text" id="turma_nome_turma" required>
                    </div>
                    <div class="form-group">
                        <label for="turma_periodo">Período</label>
                        <select id="turma_periodo">
                            <option value="">Selecione</option>
                            <option>Manhã</option>
                            <option>Tarde</option>
                            <option>Noite</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="turma_ano_letivo">Ano Letivo</label>
                        <input type="number" id="turma_ano_letivo" placeholder="Ex: 2024">
                    </div>
                    <div class="form-group">
                        <label for="turma_descricao">Descrição</label>
                        <input type="text" id="turma_descricao" placeholder="Ex: Foco em preparação para vestibular">
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="submit" class="btn btn-primary">Salvar Turma</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddTurmaModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    <div id="global-loader" class="loader-overlay">
        <div class="spinner"></div>
    </div>

    <script>
        const API_BASE_URL_ALUNOS = '/api/alunos';
        const API_BASE_URL_TURMAS = '/api/turmas';
        const API_LOGIN_URL = 'login.html';

        const alunoModal = document.getElementById('alunoModal');
        const alunoForm = document.getElementById('aluno-form');
        const modalTitle = document.getElementById('modal-title');
        const modalMessageArea = document.getElementById('modal-message-area');
        const messageArea = document.getElementById('message-area');
        const alunosTableBody = document.getElementById('alunos-table-body');

        const toggleFilterBtn = document.getElementById('toggle-filter-btn');
        const filterArea = document.getElementById('filter-area');

        toggleFilterBtn.addEventListener('click', () => {
            // A função toggle adiciona a classe 'hidden' se ela não existir,
            // e a remove se ela já existir. É a forma mais simples de alternar.
            filterArea.classList.toggle('hidden');
        });

        // INÍCIO: CONSTANTES DO NOVO MODAL DE TURMA
        const turmaModal = document.getElementById('turmaModal');
        const turmaForm = document.getElementById('turma-form');
        const turmaModalMessageArea = document.getElementById('turma-modal-message-area');
        // FIM: CONSTANTES DO NOVO MODAL DE TURMA

        const cleanNumber = (num) => num ? String(num).replace(/\D/g, '') : null;

        function displayMessage(message, type, area = messageArea) {
            area.textContent = message;
            area.className = `message ${type}`;
            area.classList.remove('hidden');
            setTimeout(() => area.classList.add('hidden'), 5000);
        }

        function openAddModal() {
            alunoForm.reset();
            document.getElementById('id_aluno').value = '';
            modalTitle.textContent = 'Cadastrar Novo Aluno';
            modalMessageArea.classList.add('hidden');
            alunoModal.style.display = 'flex';
        }

        // INÍCIO: FUNÇÕES PARA CONTROLAR O NOVO MODAL DE TURMA
        function openAddTurmaModal() {
            turmaForm.reset();
            turmaModalMessageArea.classList.add('hidden');
            turmaModal.style.display = 'flex';
        }

        function closeAddTurmaModal() {
            turmaModal.style.display = 'none';
        }
        // FIM: FUNÇÕES PARA CONTROLAR O NOVO MODAL DE TURMA


        async function openEditModal(id) {
            alunoForm.reset();
            modalTitle.textContent = 'Carregando dados para edição...';
            modalMessageArea.classList.add('hidden');
            alunoModal.style.display = 'flex';

            try {
                showLoader(); // ADICIONADO: Mostra o loader antes de buscar os dados

                const response = await fetch(`${API_BASE_URL_ALUNOS}/${id}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('jwt_token')}` }
                });
                if (!response.ok) throw new Error('Falha ao carregar dados do aluno.');

                const result = await response.json();

                if (result.success) {
                    const aluno = result.data;
                    modalTitle.textContent = `Editar Aluno (ID: ${aluno.id_aluno})`;
                    for (const key in aluno) {
                        const field = document.getElementById(key);
                        if (field) {
                            // O campo data_nascimento precisa ser formatado para o tipo 'date'
                            if (field.type === 'date' && aluno[key]) {
                                field.value = aluno[key].split(' ')[0]; // Pega apenas a parte da data (YYYY-MM-DD)
                            } else {
                                field.value = aluno[key] || '';
                            }
                        }
                    }
                    // Dispara o evento 'change' para calcular a idade
                    document.getElementById('data_nascimento').dispatchEvent(new Event('change'));
                } else {
                    displayMessage(result.message, 'error', modalMessageArea);
                }
            } catch (error) {
                displayMessage(error.message, 'error', modalMessageArea);
            } finally {
                hideLoader(); // ADICIONADO: Garante que o loader seja escondido ao final, com sucesso ou erro
            }
        }

        function closeModal() {
            alunoModal.style.display = 'none';
        }

        document.getElementById('data_nascimento').addEventListener('change', (e) => {
            if (e.target.value) {
                const birthDate = new Date(e.target.value);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                document.getElementById('idade').value = age;
            } else {
                document.getElementById('idade').value = '';
            }
        });

        document.getElementById('cep').addEventListener('blur', async (e) => {
            const cep = cleanNumber(e.target.value);
            if (cep && cep.length === 8) {
                try {
                    const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const data = await response.json();
                    if (!data.erro) {
                        document.getElementById('endereco').value = data.logradouro || '';
                        document.getElementById('bairro').value = data.bairro || '';
                        document.getElementById('cidade').value = data.localidade || '';
                        document.getElementById('estado').value = data.uf || '';
                    }
                } catch (error) { console.error("Erro ao buscar CEP:", error); }
            }
        });

        alunoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = alunoForm.querySelector('button[type="submit"]');
            const originalButtonContent = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = `<div class="btn-spinner"></div> Salvando...`;

            const id = document.getElementById('id_aluno').value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_BASE_URL_ALUNOS}/${id}` : API_BASE_URL_ALUNOS;

            const formData = new FormData(alunoForm);
            const alunoData = {};
            formData.forEach((value, key) => {
                alunoData[key] = value === '' ? null : value;
            });
            if (id) {
                alunoData.id_aluno = id;
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('jwt_token')}` },
                    body: JSON.stringify(alunoData)
                });
                const result = await response.json();
                if (result.success) {
                    displayMessage(result.message, 'success');
                    closeModal();
                    fetchAlunos();
                } else {
                    displayMessage(result.message, 'error', modalMessageArea);
                }
            } catch (error) {
                displayMessage('Erro de conexão ao salvar aluno. Verifique o console para mais detalhes.', 'error', modalMessageArea);
                console.error('Fetch error:', error);
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonContent;
            }
        });

        // INÍCIO: SUBMISSÃO DO FORMULÁRIO DE NOVA TURMA
        turmaForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitButton = turmaForm.querySelector('button[type="submit"]');
            const originalButtonContent = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = 'Salvando...';

            const turmaData = {
                nome_turma: document.getElementById('turma_nome_turma').value,
                periodo: document.getElementById('turma_periodo').value,
                ano_letivo: document.getElementById('turma_ano_letivo').value,
                descricao: document.getElementById('turma_descricao').value,
            };

            try {
                const response = await fetch(API_BASE_URL_TURMAS, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('jwt_token')}` },
                    body: JSON.stringify(turmaData)
                });
                const result = await response.json();

                if (result.success) {
                    const newTurma = result.data; // API retorna os dados da turma criada
                    const turmaSelect = document.getElementById('id_turma');

                    // Cria a nova opção, adiciona ao select e já a seleciona
                    const newOption = new Option(newTurma.nome_turma, newTurma.id_turma, true, true);
                    turmaSelect.add(newOption);

                    displayMessage('Turma criada e selecionada com sucesso!', 'success');
                    closeAddTurmaModal();
                } else {
                    displayMessage(result.message, 'error', turmaModalMessageArea);
                }
            } catch (error) {
                displayMessage('Erro de conexão ao criar turma.', 'error', turmaModalMessageArea);
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonContent;
            }
        });
        // FIM: SUBMISSÃO DO FORMULÁRIO DE NOVA TURMA

        async function fetchTurmas() {
            try {
                const response = await fetch(API_BASE_URL_TURMAS, { headers: { 'Authorization': `Bearer ${localStorage.getItem('jwt_token')}` } });
                if (!response.ok) return;
                const result = await response.json();
                if (result.success) {
                    const select = document.getElementById('id_turma');
                    select.innerHTML = '<option value="">Selecione a Turma</option>';
                    result.data.forEach(turma => {
                        select.innerHTML += `<option value="${turma.id_turma}">${turma.nome_turma}</option>`;
                    });
                }
            } catch (error) { console.error("Erro ao buscar turmas:", error); }
        }

        async function fetchAlunos() {
            showLoader();
            alunosTableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Carregando...</td></tr>';
            const searchName = document.getElementById('search_name').value.trim();
            const searchRa = document.getElementById('search_ra_sef').value.trim();
            let url = API_BASE_URL_ALUNOS;
            const params = new URLSearchParams();

            if (searchName) {
                params.append('nome', searchName);
            }
            if (searchRa) {
                params.append('ra', searchRa);
            }
            if (params.toString()) {
                url += '?' + params.toString();
            }

            const userRole = localStorage.getItem('user_role');

            try {
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${localStorage.getItem('jwt_token')}` } });
                if (!response.ok) throw new Error('Falha ao carregar alunos.');
                const result = await response.json();

                const totalDisplay = document.getElementById('total-alunos-display');

                if (totalDisplay && result.total !== undefined) {
                    totalDisplay.textContent = `${result.total} cadastrados`;
                }

                alunosTableBody.innerHTML = '';
                if (result.success && result.data.length > 0) {
                    result.data.forEach(aluno => {
                        let actionButtons = `
                    <button class="btn btn-edit text-sm" onclick="openEditModal(${aluno.id_aluno})">Editar</button>
                    <button class="btn btn-delete text-sm ml-2" onclick="deleteAluno(${aluno.id_aluno})">Excluir</button>
                `;

                        if (userRole !== 'admin') {
                            actionButtons += `
                       <button class="btn btn-info text-sm ml-2" onclick="viewBoletim(${aluno.id_aluno}, '${encodeURIComponent(aluno.nome_aluno)}', '${aluno.ra_sef}', '${encodeURIComponent(aluno.nome_turma || 'N/A')}')">Ver Boletim</button>
                    `;
                        }

                        const row = `
                    <tr>
                        <td class="px-4 py-2">${aluno.id_aluno}</td>
                        <td class="px-4 py-2 font-medium">${aluno.nome_aluno}</td>
                       <td class="px-4 py-2">${aluno.ra_sef}</td>
                        <td class="px-4 py-2">${aluno.nome_turma || 'N/A'}</td>
                        <td class="px-4 py-2">
                            <strong>Fin:</strong> ${aluno.nome_resp_financeiro || 'N/A'}<br>
                            <strong>Ped:</strong> ${aluno.nome_resp_pedagogico || 'N/A'}
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap">
                            ${actionButtons}
                        </td>
                    </tr>
                `;
                        alunosTableBody.innerHTML += row;
                    });
                } else {
                    alunosTableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Nenhum aluno encontrado.</td></tr>';
                }
            } catch (error) {
                displayMessage(error.message, 'error');
            } finally {
                hideLoader();
            }
        }

        function clearSearch() {
            document.getElementById('search_name').value = '';
            document.getElementById('search_ra_sef').value = '';

            // Adicionado para esconder a área de filtro ao limpar
            const filterArea = document.getElementById('filter-area');
            if (!filterArea.classList.contains('hidden')) {
                filterArea.classList.add('hidden');
            }

            fetchAlunos();
        }

        window.deleteAluno = async (id) => {
            if (!confirm('Tem certeza que deseja excluir este aluno?')) return;
            try {
                const response = await fetch(`${API_BASE_URL_ALUNOS}/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('jwt_token')}` }
                });
                const result = await response.json();
                displayMessage(result.message, result.success ? 'success' : 'error');
                if (result.success) fetchAlunos();
            } catch (error) { displayMessage('Erro de conexão ao excluir aluno.', 'error'); }
        };

        window.viewBoletim = (idAluno, nomeAluno, raAluno, turmaAluno) => {
            window.location.href = `boletim_aluno_view.html?idAluno=${idAluno}&nomeAluno=${nomeAluno}&raAluno=${raAluno}&turmaAluno=${turmaAluno}`;
        };


        function logout() {
            localStorage.clear();
            window.location.href = API_LOGIN_URL;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('jwt_token');
            const role = localStorage.getItem('user_role');
            const btnImportar = document.getElementById('btnImportar');
            const inputArquivo = document.getElementById('arquivoAlunos');
            const importStatus = document.getElementById('importStatus');

            btnImportar.addEventListener('click', async () => {
                const file = inputArquivo.files[0];
                if (!file) {
                    importStatus.innerHTML = `<p class="text-red-600 font-semibold">Por favor, selecione um arquivo para importar.</p>`;
                    return;
                }

                const formData = new FormData();
                formData.append('arquivo_alunos', file);

                // Feedback visual para o usuário
                btnImportar.disabled = true;
                btnImportar.textContent = 'Importando...';
                importStatus.innerHTML = `<p class="text-blue-600">Enviando e processando o arquivo. Isso pode levar alguns minutos...</p>`;

                try {
                    const response = await fetch(`${API_BASE_URL_ALUNOS}/importar`, {
                        method: 'POST',
                        headers: {
                            // Não defina 'Content-Type', o navegador faz isso automaticamente para FormData
                            'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`
                        },
                        body: formData
                    });

                    const result = await response.json();

                    if (response.ok) {
                        importStatus.innerHTML = `<p class="text-green-600 font-semibold">${result.message}</p>`;
                        inputArquivo.value = ''; // Limpa o campo de arquivo
                        fetchAlunos(); // Atualiza a lista de alunos na tela
                    } else {
                        // Monta uma mensagem de erro detalhada
                        let errorHtml = `<p class="text-red-600 font-semibold">${result.message || 'Ocorreu um erro na importação.'}</p>`;
                        if (result.errors && Array.isArray(result.errors) && result.errors.length > 0) {
                            errorHtml += '<ul class="list-disc list-inside mt-2 text-red-500 max-h-40 overflow-y-auto">';
                            result.errors.forEach(err => {
                                errorHtml += `<li>${err}</li>`;
                            });
                            errorHtml += '</ul>';
                        }
                        importStatus.innerHTML = errorHtml;
                    }

                } catch (error) {
                    importStatus.innerHTML = `<p class="text-red-600">Ocorreu um erro de conexão ao tentar importar. Verifique o console para mais detalhes.</p>`;
                    console.error('Erro na requisição de importação:', error);
                } finally {
                    // Restaura o estado do botão
                    btnImportar.disabled = false;
                    btnImportar.textContent = 'Importar';
                }
            });
            if (!token || (role !== 'professor' && role !== 'admin' && role !== 'aluno')) {
                window.location.href = API_LOGIN_URL;
                return;
            }
            fetchTurmas();
            fetchAlunos();
        });
    </script>
</body>

</html>