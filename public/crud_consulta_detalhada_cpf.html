<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta Detalhada de CPF - Sistema Crescer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/loader.css">
    <script src="js/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="icon" type="image/png" href="./img/EDU SEF.png">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 1rem;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        .btn-primary {
            background-color: #4f46e5;
            color: #ffffff;
        }

        .btn-primary:hover {
            background-color: #4338ca;
        }

        .message {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .message.success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #34d399;
        }

        .message.error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .section-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .section-header {
            color: #1f2937;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .data-item {
            display: flex;
            flex-direction: column;
        }

        .data-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }

        .data-value {
            font-size: 1rem;
            color: #1f2937;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .results-table th,
        .results-table td {
            text-align: left;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .results-table th {
            background-color: #f3f4f6;
            font-size: 0.875rem;
            color: #4b5563;
        }

        #global-loader {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .spinner {
            border: 8px solid rgba(255, 255, 255, 0.1);
            border-left: 8px solid #ffffff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .nav-link {
            color: #D1D5DB;
            background-color: transparent;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }

        .nav-link:hover {
            background-color: #374151;
            color: #FFFFFF;
        }

        .nav-link.active {
            background-color: #111827;
            color: #FFFFFF;
            font-weight: 600;
        }

        .spinner-small {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>
</head>

<body>
    <nav class="bg-gray-800 p-4 shadow-md">
        <div class="mx-auto flex max-w-7xl items-center justify-between px-4">
            <a href="home.html" class="text-white text-2xl font-bold text-left">EDU SEF - Sistema Educacional
                Financeiro</a>
            <div class="flex items-center space-x-4">
                <div class="relative group">
                    <button class="nav-link">
                        Consultas <span class="ml-1">&#9660;</span>
                    </button>
                    <div
                        class="absolute right-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg py-1 z-10 hidden group-hover:block">
                        <a href="crud_consultar_cpf.html"
                            class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700">Consulta SEF</a>
                        <a href="crud_consulta_detalhada_cpf.html"
                            class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-700">Consulta Detalhada</a>
                    </div>
                </div>
                <a href="crud_alunos.html" class="nav-link">Alunos</a>
                <a href="crud_turmas.html" class="nav-link">Turmas</a>
                <a href="crud_professores.html" class="nav-link">Professores</a>
                <a href="crud_disciplinas.html" class="nav-link">Disciplinas</a>
                <a href="crud_mensalidades.html" class="nav-link">Mensalidades</a>
                <a href="gerenciar_contratos.html" class="nav-link">Contratos</a>
                <a href="financeiro.html" class="nav-link">Financeiro</a>
                <a id="nav-gerenciar-usuarios" href="gerenciar_usuarios.html" class="nav-link">Gerenciar Usuários</a>
                <button onclick="logout()" class="nav-link">Sair</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Relatório Detalhado de CPF</h1>
        <div id="message-area"></div>

        <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Verificar CPF</h2>
            <form id="form-consultar-cpf" class="grid grid-cols-1 md:grid-cols-4 gap-5 items-end">
                <div class="form-group md:col-span-3">
                    <label for="cpf-input">CPF do Responsável</label>
                    <input type="text" id="cpf-input" name="cpf" required placeholder="Digite o CPF (somente números)"
                        maxlength="11" class="bg-white">
                </div>
                <button type="submit" id="btn-consultar" class="btn btn-primary h-12">Consultar</button>
            </form>
        </div>

        <div id="loading-message" class="text-center text-gray-500 my-8 hidden">Buscando dados detalhados, aguarde...
        </div>

        <div class="flex justify-end mb-4">
            <button id="btn-gerar-pdf" class="btn btn-primary hidden">Gerar PDF</button>
        </div>

        <div id="report-details" class="hidden">
            <div class="section-card">
                <h2 class="section-header">Informações Pessoais</h2>
                <div class="data-grid">
                    <div class="data-item"><span class="data-label">Nome</span><span id="nome-value"
                            class="data-value"></span></div>
                    <div class="data-item"><span class="data-label">CPF</span><span id="cpf-value"
                            class="data-value"></span></div>
                    <div class="data-item"><span class="data-label">Nome da Mãe</span><span id="nome-mae-value"
                            class="data-value"></span></div>
                    <div class="data-item"><span class="data-label">Data de Nascimento</span><span
                            id="data-nascimento-value" class="data-value"></span></div>
                    <div class="data-item"><span class="data-label">Gênero</span><span id="genero-value"
                            class="data-value"></span></div>
                    <div class="data-item"><span class="data-label">Estado Civil</span><span id="estado-civil-value"
                            class="data-value"></span></div>
                    <div class="data-item"><span class="data-label">Ocupação</span><span id="ocupacao-value"
                            class="data-value"></span></div>
                    <div class="data-item"><span class="data-label">Escolaridade</span><span id="escolaridade-value"
                            class="data-value"></span></div>
                    <div class="data-item"><span class="data-label">Dependentes</span><span id="dependentes-value"
                            class="data-value"></span></div>
                    <div class="data-item"><span class="data-label">Status do CPF</span><span id="status-cpf-value"
                            class="data-value"></span></div>
                </div>
            </div>
            <div class="section-card">
                <h2 class="section-header">Endereços</h2>
                <div id="enderecos-list" class="space-y-4"></div>
            </div>
            <div class="section-card">
                <h2 class="section-header">Telefones</h2>
                <div id="telefones-list" class="space-y-4"></div>
            </div>
            <div class="section-card">
                <h2 class="section-header">Pendências Financeiras</h2>
                <div id="pendencias-list" class="space-y-4"></div>
            </div>
            <div class="section-card">
                <h2 class="section-header">Consultas Recentes</h2>
                <div id="consultas-list" class="space-y-4"></div>
            </div>
            <div class="section-card">
                <h2 class="section-header">Participação Societária</h2>
                <div id="societaria-list" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <div id="pix-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Confirmar Consulta</h3>
                <div class="mt-2 px-7 py-3" id="modal-content">
                    <div id="modal-step-confirm">
                        <p class="text-sm text-gray-500">A consulta detalhada tem um custo de <strong>R$ 20,00</strong>.
                            Deseja continuar?</p>
                    </div>
                    <div id="modal-step-pix" class="hidden">
                        <img id="pix-qrcode" src="" alt="PIX QR Code" class="mx-auto w-48 h-48 border rounded">
                        <div class="mt-4">
                            <label for="pix-key" class="text-xs font-semibold text-gray-600">PIX Copia e Cola:</label>
                            <div class="flex items-center mt-1">
                                <input type="text" id="pix-key" readonly
                                    class="w-full bg-gray-100 p-2 border rounded-l-md text-xs">
                                <button id="btn-copy-pix"
                                    class="bg-gray-200 hover:bg-gray-300 p-2.5 rounded-r-md text-sm">Copiar</button>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="flex justify-between items-center mb-1">
                                <p class="text-xs text-gray-500 text-left">Tempo restante:</p>
                                <p id="time-display" class="text-sm font-semibold text-gray-700">05:00</p>
                            </div>
                            <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="progress-bar-fill"
                                    class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300 ease-linear"
                                    style="width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="modal-step-waiting" class="hidden py-4">
                    <div class="flex flex-col items-center justify-center">
                        <div class="spinner-small"></div>
                        <p class="text-gray-600 mt-3 font-semibold">Aguardando confirmação de pagamento...</p>
                        <p class="text-xs text-gray-400 mt-2">Pode levar alguns instantes. Não feche esta janela.
                        </p>
                    </div>
                </div>
            </div>
            <div class="items-center px-4 py-3" id="modal-actions">
                <div id="modal-actions-confirm">
                    <button id="btn-confirm-pix"
                        class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-600">Confirmar
                        e Gerar PIX</button>
                    <button id="btn-cancel-modal"
                        class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">Cancelar</button>
                </div>
                <div id="modal-actions-close" class="hidden">
                    <button id="btn-close-modal"
                        class="mt-2 px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600">Fechar</button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <div id="global-loader">
        <div class="spinner"></div>
    </div>

    <script>
        // --- CONSTANTES DE API ---
        const API_LOGIN_URL = 'login.html';
        const CONSULTA_DETALHADA_WEBHOOK_URL = 'https://sistema-crescer-n8n.vuvd0x.easypanel.host/webhook-test/consulta-detalhada';
        const PIX_WEBHOOK_URL = 'https://sistema-crescer-n8n.vuvd0x.easypanel.host/webhook/pix_consulta';
        const VERIFICAR_PAGAMENTO_URL = 'https://sistema-crescer-n8n.vuvd0x.easypanel.host/webhook/verificar-pagamento';

        // --- ELEMENTOS DO DOM ---
        const formConsultaCpf = document.getElementById('form-consultar-cpf'), cpfInput = document.getElementById('cpf-input');
        const loadingMessage = document.getElementById('loading-message'), reportDetails = document.getElementById('report-details');
        const messageArea = document.getElementById('message-area'), btnGerarPdf = document.getElementById('btn-gerar-pdf');
        const pixModal = document.getElementById('pix-modal'), modalTitle = document.getElementById('modal-title');
        const modalStepConfirm = document.getElementById('modal-step-confirm'), modalStepPix = document.getElementById('modal-step-pix');
        const modalStepWaiting = document.getElementById('modal-step-waiting');
        const modalActionsConfirm = document.getElementById('modal-actions-confirm'), modalActionsClose = document.getElementById('modal-actions-close');
        const btnConfirmPix = document.getElementById('btn-confirm-pix'), btnCancelModal = document.getElementById('btn-cancel-modal');
        const btnCloseModal = document.getElementById('btn-close-modal'), btnCopyPix = document.getElementById('btn-copy-pix');
        const pixQrcode = document.getElementById('pix-qrcode'), pixKeyInput = document.getElementById('pix-key');
        // Elementos da barra de progresso e tempo
        const progressBarFill = document.getElementById('progress-bar-fill');
        const timeDisplay = document.getElementById('time-display'); // NOVO: Elemento para mostrar o tempo

        let pollingInterval = null;
        let pollingTimeout = null;
        let progressBarInterval = null;

        // --- FUNÇÕES AUXILIARES ---
        window.showLoader = () => document.getElementById('global-loader').style.display = 'flex';
        window.hideLoader = () => document.getElementById('global-loader').style.display = 'none';
        function logout() { localStorage.clear(); window.location.href = API_LOGIN_URL; }
        function displayMessage(message, type) { messageArea.innerHTML = `<div class="message ${type}">${message}</div>`; setTimeout(() => messageArea.innerHTML = '', 6000); }
        const formatDate = (dateString) => dateString ? new Date(dateString).toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : 'N/A';

        function gerarPDF() {
            const element = document.getElementById('report-details');
            const nome = document.getElementById('nome-value').textContent || 'Relatório de CPF';
            const opt = {
                margin: [10, 10, 10, 10],
                filename: `${nome.toLowerCase().replace(/ /g, '_')}_detalhado.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().from(element).set(opt).save();
        }

        // --- LÓGICA DO MODAL E PAGAMENTO ---
        function resetModal() {
            modalTitle.textContent = 'Confirmar Consulta';
            modalStepConfirm.classList.remove('hidden');
            modalStepPix.classList.add('hidden');
            modalStepWaiting.classList.add('hidden');
            modalActionsConfirm.classList.remove('hidden');
            modalActionsClose.classList.add('hidden');
            if (pollingInterval) clearInterval(pollingInterval);
            if (pollingTimeout) clearTimeout(pollingTimeout);
            if (progressBarInterval) clearInterval(progressBarInterval);
            // Reseta a barra e o tempo para o estado inicial
            if (progressBarFill) progressBarFill.style.width = '100%';
            if (timeDisplay) timeDisplay.textContent = '05:00';
        }

        function showConfirmationModal() {
            resetModal();
            pixModal.classList.remove('hidden');
        }

        function hidePixModal() {
            pixModal.classList.add('hidden');
            resetModal();
        }

        async function startPaymentPolling(transactionId, token) {
            const cpf = cpfInput.value.trim().replace(/\D/g, '');

            // --- LÓGICA DA BARRA E CRONÔMETRO ---
            const duration = 300000; // 5 minutos em ms
            const startTime = Date.now();
            if (progressBarFill) progressBarFill.style.width = '100%';
            if (timeDisplay) timeDisplay.textContent = '05:00';
            if (progressBarInterval) clearInterval(progressBarInterval);

            progressBarInterval = setInterval(() => {
                const elapsedTime = Date.now() - startTime;
                const remainingTime = duration - elapsedTime;

                if (remainingTime <= 0) {
                    progressBarFill.style.width = '0%';
                    timeDisplay.textContent = '00:00';
                    clearInterval(progressBarInterval);
                    return;
                }

                // ** NOVO: Calcula e formata minutos e segundos **
                const totalSeconds = Math.floor(remainingTime / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                const formattedMinutes = String(minutes).padStart(2, '0');
                const formattedSeconds = String(seconds).padStart(2, '0');

                // Atualiza o texto do cronômetro e a barra
                timeDisplay.textContent = `${formattedMinutes}:${formattedSeconds}`;
                const remainingPercentage = (remainingTime / duration) * 100;
                progressBarFill.style.width = `${remainingPercentage}%`;

            }, 1000); // Atualiza a cada segundo

            // --- LÓGICA DE VERIFICAÇÃO DE PAGAMENTO ---
            pollingTimeout = setTimeout(() => {
                clearInterval(pollingInterval);
                displayMessage('Tempo para pagamento esgotado. Por favor, tente novamente.', 'error');
                hidePixModal();
            }, duration);

            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${VERIFICAR_PAGAMENTO_URL}?transactionId=${transactionId}`);
                    const result = await response.json();

                    if (result.status === 'approved') {
                        clearInterval(pollingInterval);
                        clearTimeout(pollingTimeout);
                        clearInterval(progressBarInterval);

                        modalStepPix.classList.add('hidden');
                        modalActionsClose.classList.add('hidden');
                        modalStepWaiting.classList.remove('hidden');
                        modalStepWaiting.innerHTML = '<p class="text-green-600 font-semibold">Pagamento confirmado!</p><p class="text-sm text-gray-500">Gerando seu relatório...</p>';

                        await executeDetailedConsultation(cpf, token);
                        setTimeout(hidePixModal, 2000);
                    }
                } catch (error) {
                    console.error('Erro ao verificar pagamento:', error);
                    clearInterval(pollingInterval);
                    clearTimeout(pollingTimeout);
                    clearInterval(progressBarInterval);
                    displayMessage('Ocorreu um erro ao verificar o pagamento. Tente mais tarde.', 'error');
                    hidePixModal();
                }
            }, 10000);
        }

        // --- LÓGICA PRINCIPAL ---
        formConsultaCpf.addEventListener('submit', (e) => {
            e.preventDefault();
            const cpf = cpfInput.value.trim().replace(/\D/g, '');
            if (cpf.length !== 11) {
                displayMessage('Por favor, digite um CPF válido com 11 dígitos.', 'error');
                return;
            }
            showConfirmationModal();
        });

        btnConfirmPix.addEventListener('click', async () => {
            const token = localStorage.getItem('jwt_token');
            const userName = localStorage.getItem('user_name') || 'Usuário';

            if (!token) {
                displayMessage('Token de autenticação ausente. Faça login novamente.', 'error');
                hidePixModal();
                return;
            }

            btnConfirmPix.disabled = true;
            btnConfirmPix.textContent = 'Gerando...';

            try {
                const pixResponse = await fetch(PIX_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ nome: userName, valor: 20 })
                });

                if (!pixResponse.ok) throw new Error((await pixResponse.json()).message || 'Não foi possível gerar o PIX.');

                const pixData = await pixResponse.json();

                if (!pixData.transactionId) {
                    throw new Error('A resposta da API de PIX não retornou um ID de transação.');
                }

                pixQrcode.src = `data:image/png;base64,${pixData.base64}`;
                pixKeyInput.value = pixData.chave_aleatoria;

                modalTitle.textContent = 'Efetue o Pagamento';
                modalStepConfirm.classList.add('hidden');
                modalActionsConfirm.classList.add('hidden');
                modalStepPix.classList.remove('hidden');
                modalActionsClose.classList.remove('hidden');

                startPaymentPolling(pixData.transactionId, token);

            } catch (error) {
                console.error("Erro ao gerar PIX:", error);
                displayMessage(`Erro ao gerar PIX: ${error.message}`, 'error');
                hidePixModal();
            } finally {
                btnConfirmPix.disabled = false;
                btnConfirmPix.textContent = 'Confirmar e Gerar PIX';
            }
        });

        async function executeDetailedConsultation(cpf, token) {
            showLoader();
            reportDetails.classList.add('hidden');
            btnGerarPdf.classList.add('hidden');
            try {
                const response = await fetch(CONSULTA_DETALHADA_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ cpf: cpf })
                });

                if (!response.ok) throw new Error((await response.json()).message || 'Erro ao buscar o relatório.');

                renderDetailedReport(await response.json());

            } catch (error) {
                console.error("Erro no relatório:", error);
                displayMessage(`Erro na consulta: ${error.message}`, 'error');
                reportDetails.classList.add('hidden');
            } finally {
                hideLoader();
            }
        }

        function renderDetailedReport(data) {
            if (!data || !data.reports || data.reports.length === 0) {
                displayMessage('Nenhum relatório detalhado encontrado para este CPF.', 'error');
                reportDetails.classList.add('hidden');
                return;
            }

            const report = data.reports[0];
            const reg = report.registration;
            const neg = report.negativeData;
            const facts = report.facts;
            const partner = report.partner;
            const check = neg.check;

            document.getElementById('nome-value').textContent = reg.consumerName || 'N/A';
            document.getElementById('cpf-value').textContent = reg.documentNumber ? reg.documentNumber.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4') : 'N/A';
            document.getElementById('nome-mae-value').textContent = reg.motherName || 'N/A';
            document.getElementById('data-nascimento-value').textContent = formatDate(reg.birthDate);
            document.getElementById('genero-value').textContent = reg.consumerGenderDescription || 'N/A';
            document.getElementById('estado-civil-value').textContent = reg.maritalStatusDescription || 'N/A';
            document.getElementById('ocupacao-value').textContent = reg.jobDescription || 'N/A';
            document.getElementById('escolaridade-value').textContent = reg.educationLevelDescription || 'N/A';
            document.getElementById('dependentes-value').textContent = reg.dependentsNumber || 'N/A';
            document.getElementById('status-cpf-value').textContent = reg.statusRegistration || 'N/A';

            const enderecosList = document.getElementById('enderecos-list');
            enderecosList.innerHTML = '';
            if (reg.addresses && reg.addresses.length > 0) {
                reg.addresses.forEach(addr => {
                    const div = document.createElement('div');
                    div.className = 'bg-white p-4 rounded-md shadow-sm';
                    div.innerHTML = `<p class="font-medium text-gray-700">${addr.addressLine}, ${addr.addressNumber || ''} - ${addr.district || ''}</p><p class="text-sm text-gray-500">${addr.city || ''} - ${addr.state || ''}, CEP: ${addr.zipCode || 'N/A'}</p><p class="text-xs text-gray-400">Tipo: ${addr.addressTypeDescription || 'N/A'} | Atualizado em: ${formatDate(addr.updateDate)}</p>`;
                    enderecosList.appendChild(div);
                });
            } else {
                enderecosList.innerHTML = '<p class="text-gray-500">Nenhum endereço encontrado.</p>';
            }

            const telefonesList = document.getElementById('telefones-list');
            telefonesList.innerHTML = '';
            if (reg.phones && reg.phones.length > 0) {
                reg.phones.forEach(phone => {
                    const div = document.createElement('div');
                    div.className = 'bg-white p-4 rounded-md shadow-sm';
                    div.innerHTML = `<p class="font-medium text-gray-700">(+${phone.regionCode}) ${phone.areaCode} ${phone.phoneNumber}</p><p class="text-sm text-gray-500">Tipo: ${phone.phoneType || 'N/A'} | Atualizado em: ${formatDate(phone.updateDate)}</p>`;
                    telefonesList.appendChild(div);
                });
            } else {
                telefonesList.innerHTML = '<p class="text-gray-500">Nenhum telefone encontrado.</p>';
            }

            const pendenciasList = document.getElementById('pendencias-list');
            pendenciasList.innerHTML = '';
            const allPendencias = [...(neg.pefin?.pefinResponse || []), ...(neg.refin?.refinResponse || []), ...(neg.notary?.notaryResponse || []), ...(check.checkResponse || [])];
            if (allPendencias.length > 0) {
                const table = document.createElement('table');
                table.className = 'results-table';
                table.innerHTML = `<thead><tr><th>Credor / Banco</th><th>Valor (R$)</th><th>Data Ocorrência</th><th>Natureza</th></tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');
                allPendencias.forEach(item => {
                    const row = document.createElement('tr');
                    const formattedAmount = (item.amount || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    const creditorName = item.creditorName || item.credor || item.bankName || 'N/A';
                    row.innerHTML = `<td>${creditorName}</td><td>${formattedAmount}</td><td>${formatDate(item.occurrenceDate)}</td><td>${item.legalNature || 'Cheque'}</td>`;
                    tbody.appendChild(row);
                });
                pendenciasList.appendChild(table);
            } else {
                pendenciasList.innerHTML = '<p class="text-gray-500">Nenhuma pendência financeira encontrada.</p>';
            }

            const consultasList = document.getElementById('consultas-list');
            consultasList.innerHTML = '';
            if (facts.inquiry?.inquiryResponse && facts.inquiry.inquiryResponse.length > 0) {
                const table = document.createElement('table');
                table.className = 'results-table';
                table.innerHTML = `<thead><tr><th>Data da Consulta</th><th>Segmento</th><th>Quantidade de Dias</th></tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');
                facts.inquiry.inquiryResponse.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${formatDate(item.occurrenceDate)}</td><td>${item.segmentDescription || 'N/A'}</td><td>${item.daysQuantity || 'N/A'}</td>`;
                    tbody.appendChild(row);
                });
                consultasList.appendChild(table);
            } else {
                consultasList.innerHTML = '<p class="text-gray-500">Nenhuma consulta recente encontrada.</p>';
            }

            const societariaList = document.getElementById('societaria-list');
            societariaList.innerHTML = '';
            if (partner.partnershipResponse && partner.partnershipResponse.length > 0) {
                const table = document.createElement('table');
                table.className = 'results-table';
                table.innerHTML = `<thead><tr><th>CNPJ</th><th>Nome da Empresa</th><th>% Participação</th><th>Status</th></tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');
                partner.partnershipResponse.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${item.businessDocument || 'N/A'}</td><td>${item.companyName || 'N/A'}</td><td>${item.participationPercentage !== undefined ? `${item.participationPercentage}%` : 'N/A'}</td><td>${item.companyStatus || 'N/A'}</td>`;
                    tbody.appendChild(row);
                });
                societariaList.appendChild(table);
            } else {
                societariaList.innerHTML = '<p class="text-gray-500">Nenhuma participação societária encontrada.</p>';
            }

            reportDetails.classList.remove('hidden');
            btnGerarPdf.classList.remove('hidden');
        }

        // --- EVENT LISTENERS ---
        btnCancelModal.addEventListener('click', hidePixModal);
        btnCloseModal.addEventListener('click', hidePixModal);
        btnCopyPix.addEventListener('click', () => {
            pixKeyInput.select();
            document.execCommand('copy');
            btnCopyPix.textContent = 'Copiado!';
            setTimeout(() => btnCopyPix.textContent = 'Copiar', 2000);
        });

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('jwt_token');
            const role = localStorage.getItem('user_role');
            if (!token || role !== 'admin') {
                window.location.href = API_LOGIN_URL;
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const cpfUrl = urlParams.get('cpf');
            if (cpfUrl) {
                cpfInput.value = cpfUrl;
                setTimeout(() => document.getElementById('btn-consultar').click(), 100);
            }

            cpfInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '').slice(0, 11);
            });

            btnGerarPdf.addEventListener('click', gerarPDF);
        });
    </script>
</body>

</html>