<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Matrícula</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            /* Fundo cinza claro */
        }

        .form-container {
            max-width: 800px;
            margin: 2.5rem auto;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-top: 8px solid #4f46e5;
            /* Borda roxa no topo, como o Google Forms */
        }

        .form-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .form-section {
            padding: 2rem;
            margin-bottom: 1rem;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        .form-section legend {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        input[type="text"],
        input[type="email"],
        input[type="date"],
        input[type="tel"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
            outline: none;
        }

        /* Classe de loading para botões */
        .btn-loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            left: calc(50% - 0.75rem);
            top: calc(50% - 0.75rem);
            height: 1.5rem;
            width: 1.5rem;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div class="form-container">
        <div class="form-header">
            <h1 class="text-3xl font-bold text-gray-800">Formulário de Matrícula</h1>
            <p class="text-gray-600 mt-2">Por favor, preencha os dados abaixo para completar a ficha do aluno. Os dados
                financeiros já foram definidos pelo administrador.</p>
        </div>

        <div id="form-wrapper" class="p-8">
            <form id="form-responsavel" class="space-y-6">

                <!-- Seção 1: Dados do Aluno -->
                <fieldset class="form-section">
                    <legend>Dados do Aluno(a)</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="aluno_nome">Nome Completo</label>
                            <input type="text" id="aluno_nome" name="aluno_nome" required>
                        </div>
                        <div>
                            <label for="aluno_nascimento">Data de Nascimento</label>
                            <input type="date" id="aluno_nascimento" name="aluno_nascimento" required>
                        </div>
                        <div>
                            <label for="aluno_rg">RG (se possuir)</label>
                            <input type="text" id="aluno_rg" name="aluno_rg">
                        </div>
                        <div>
                            <label for="aluno_cpf">CPF (se possuir)</label>
                            <input type="text" id="aluno_cpf" name="aluno_cpf">
                        </div>
                    </div>
                </fieldset>

                <!-- Seção 2: Endereço -->
                <fieldset class="form-section">
                    <legend>Endereço</legend>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="md:col-span-1">
                            <label for="cep">CEP</label>
                            <input type="text" id="cep" name="cep">
                        </div>
                        <div class="md:col-span-3">
                            <label for="endereco">Endereço (Rua, N°)</label>
                            <input type="text" id="endereco" name="endereco">
                        </div>
                        <div class="md:col-span-2">
                            <label for="bairro">Bairro</label>
                            <input type="text" id="bairro" name="bairro">
                        </div>
                        <div class="md:col-span-2">
                            <label for="cidade">Cidade</label>
                            <input type="text" id="cidade" name="cidade">
                        </div>
                        <div class="md:col-span-1">
                            <label for="estado">Estado (UF)</label>
                            <input type="text" id="estado" name="estado" maxlength="2">
                        </div>
                        <div class="md:col-span-3">
                            <label for="complemento">Complemento (Apto, Bloco, etc.)</label>
                            <input type="text" id="complemento" name="complemento">
                        </div>
                    </div>
                </fieldset>

                <!-- Seção 3: Responsável Financeiro (Confirmação) -->
                <fieldset class="form-section">
                    <legend>Responsável Financeiro</legend>
                    <p class="text-sm text-gray-600 mb-4">Seus dados (Nome, CPF, Celular) já foram pré-aprovados. Por
                        favor, complete as informações restantes.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="resp_fin_email">Email</label>
                            <input type="email" id="resp_fin_email" name="resp_fin_email">
                        </div>
                        <div>
                            <label for="resp_fin_nascimento">Data de Nascimento</label>
                            <input type="date" id="resp_fin_nascimento" name="resp_fin_nascimento">
                        </div>
                    </div>
                </fieldset>

                <!-- Seção 4: Responsável Pedagógico -->
                <fieldset class="form-section">
                    <legend>Responsável Pedagógico</legend>
                    <div class="flex items-center mb-4">
                        <input id="ped_igual_fin" type="checkbox"
                            class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label for="ped_igual_fin" class="ml-2 block text-sm font-medium text-gray-900">O responsável
                            pedagógico é o mesmo que o financeiro</label>
                    </div>
                    <div id="dados_pedagogico" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="resp_ped_nome">Nome Completo</label>
                            <input type="text" id="resp_ped_nome" name="resp_ped_nome">
                        </div>
                        <div>
                            <label for="resp_ped_cpf">CPF</label>
                            <input type="text" id="resp_ped_cpf" name="resp_ped_cpf">
                        </div>
                        <div>
                            <label for="resp_ped_celular">Celular</label>
                            <input type="tel" id="resp_ped_celular" name="resp_ped_celular">
                        </div>
                        <div>
                            <label for="resp_ped_email">Email</label>
                            <input type="email" id="resp_ped_email" name="resp_ped_email">
                        </div>
                        <div class="md:col-span-2">
                            <label for="resp_ped_nascimento">Data de Nascimento</label>
                            <input type="date" id="resp_ped_nascimento" name="resp_ped_nascimento">
                        </div>
                    </div>
                </fieldset>

                <!-- Botão de Envio -->
                <div class="flex justify-end pt-4">
                    <button type="submit" id="btn-enviar-dados"
                        class="w-full md:w-auto inline-flex justify-center rounded-lg border border-transparent bg-green-600 py-3 px-8 text-base font-medium text-white shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Enviar Dados
                    </button>
                </div>
            </form>

            <!-- Mensagem de erro geral -->
            <div id="form-error" class="hidden text-red-600 p-4 border border-red-300 bg-red-50 rounded-md"></div>
        </div>
    </div>

    <!-- Modal de Sucesso -->
    <div id="success-modal"
        class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md p-8 text-center">
            <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Dados Enviados!</h2>
            <p class="text-gray-600">Obrigado! A administração da escola foi notificada e revisará seus dados.</p>
            <button id="btn-fechar-sucesso"
                class="mt-6 w-full inline-flex justify-center rounded-lg border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-700">
                Fechar
            </button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = '/api'; // Ajuste se necessário
            const form = document.getElementById('form-responsavel');
            const formWrapper = document.getElementById('form-wrapper');
            const formError = document.getElementById('form-error');
            const successModal = document.getElementById('success-modal');
            const btnFecharSucesso = document.getElementById('btn-fechar-sucesso');
            const checkPedIgualFin = document.getElementById('ped_igual_fin');
            const containerDadosPed = document.getElementById('dados_pedagogico');
            const btnEnviar = document.getElementById('btn-enviar-dados');

            // Pega o token da URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            if (!token) {
                formWrapper.innerHTML = `<p class="text-center text-red-600 text-lg p-10">Link inválido ou expirado. Por favor, solicite um novo link à administração.</p>`;
            }

            // Lógica do Checkbox
            checkPedIgualFin.addEventListener('change', () => {
                if (checkPedIgualFin.checked) {
                    containerDadosPed.classList.add('hidden');
                    // Limpa campos para enviar nulo
                    document.getElementById('resp_ped_nome').value = '';
                    document.getElementById('resp_ped_cpf').value = '';
                    document.getElementById('resp_ped_celular').value = '';
                    document.getElementById('resp_ped_email').value = '';
                    document.getElementById('resp_ped_nascimento').value = '';
                } else {
                    containerDadosPed.classList.remove('hidden');
                }
            });

            // Lógica de Envio (AGORA CONECTADO)
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!token) return;

                btnEnviar.disabled = true;
                btnEnviar.classList.add('btn-loading');
                formError.classList.add('hidden');

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                data.token = token; // Adiciona o token ao payload

                // Se o checkbox estiver marcado, garante que os campos pedagógicos sejam nulos
                if (checkPedIgualFin.checked) {
                    data.resp_ped_nome = null;
                    data.resp_ped_cpf = null;
                    data.resp_ped_celular = null;
                    data.resp_ped_email = null;
                    data.resp_ped_nascimento = null;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/matricula/preencher`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }, // Rota pública
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);

                    // Sucesso!
                    successModal.classList.remove('hidden');
                    formWrapper.innerHTML = ''; // Limpa o formulário

                } catch (error) {
                    console.error("Erro ao enviar dados:", error);
                    formError.textContent = `Erro: ${error.message}`;
                    formError.classList.remove('hidden');
                } finally {
                    btnEnviar.disabled = false;
                    btnEnviar.classList.remove('btn-loading');
                }
            });

            btnFecharSucesso.addEventListener('click', () => {
                successModal.classList.add('hidden');
                // Pode fechar a aba
                // window.close(); 
            });

            // Lógica do ViaCEP
            document.getElementById('cep').addEventListener('blur', async (e) => {
                const cep = e.target.value.replace(/\D/g, '');
                if (cep && cep.length === 8) {
                    try {
                        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                        const data = await response.json();
                        if (!data.erro) {
                            document.getElementById('endereco').value = data.logradouro || '';
                            document.getElementById('bairro').value = data.bairro || '';
                            document.getElementById('cidade').value = data.localidade || '';
                            document.getElementById('estado').value = data.uf || '';
                        }
                    } catch (error) { console.error("Erro ao buscar CEP:", error); }
                }
            });
        });
    </script>
</body>

</html>